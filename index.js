import 'dotenv/config'
import { LowSync, Low } from 'lowdb'
import { JSONFileSync, JSONFilePreset } from 'lowdb/node'
import { Bot, GrammyError,HttpError, Keyboard } from "grammy";
const bot = new Bot(process.env.BOT_TOKEN);
const db = new LowSync(new JSONFileSync('users.json'), { "users": {} })
// const cl = new LowSync(new JSONFileSync('contestList.json'), { "list": {} })
const cl = await JSONFilePreset(('contestList.json'), { "users": {}})
const createChooseUserBtn = (ctx) => {
	return (
		[
			[
				{
					text: '–ö —Å–ø–∏—Å–∫—É –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤',
					request_users: {
						request_id: ctx.message.from.id,
						request_username: true,
						user_is_bot: false
					}
				}
			],
			[
				{
					text: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∏–ª–µ—Ç—ã'
				}
			],
			[
				{
					text: '<- –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é'
				}
			]
			
		])
}
bot.api.setMyCommands([
	{
		command: 'start',
		description: '–ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞'
	},
	{
		command: 'menu',
		description: '–û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é'
	},
	{
		command: 'tickets',
		description: '–ë–∏–ª–µ—Ç—ã —Ä–æ–∑—ã–≥—Ä—ã—à–∞'
	}
]);

// –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –º–µ–Ω—é
const menuLabels = ['–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ –∫–∞–Ω–∞–ª', '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∏–ª–µ—Ç—ã'];
const onFailSub = ['–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª', '<- –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é'];
const menuRows = menuLabels.map((label) => {
	return [
		Keyboard.text(label)
	]
})
const onFailSubRows = onFailSub.map((label) => {
	return [
		Keyboard.text(label)
	]
})
const menuKeyboard = Keyboard.from(menuRows).resized().oneTime()
const shareUserKeyboard = new Keyboard().text('–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞').row().text('–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∏–ª–µ—Ç—ã').row().text('<- –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é').resized()
const onFailSubKeyboard = Keyboard.from(onFailSubRows).resized().oneTime()

bot.command('start', async (ctx) => {
	if (ctx.from.is_bot === false) {
		const username = ctx.msg.from.username
		await ctx.reply(`–ü—Ä–∏–≤–µ—Ç, ${username}! –Ø - –±–æ—Ç —Ç–≥-–∫–∞–Ω–∞–ª–∞: <a href="https://t.me/shuratest">Shura Test</a>`, {
			parse_mode: 'HTML',
			reply_markup: menuKeyboard,
		})
	}
})

bot.command('menu', (ctx) => {
	ctx.reply(`–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ`, {
	parse_mode: 'HTML',
	reply_markup: menuKeyboard
})
})

bot.command('tickets', async (ctx) => {
	const userId = ctx.message.from.id;
	db.read()
	const invitedUsers = db.data.users[userId];
	let tickets;
	tickets = await invitedUsers.reduce( async  (acc, cur) => {
		try {
			let pass = await bot.api.getChatMember('@shuratest', cur);
			if (pass.status == 'member') {
				console.log(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å id: ${cur} –ø–æ–¥–ø–∏—Å–∞–ª—Å—è –Ω–∞ –∫–∞–Ω–∞–ª, –¥–æ–±–∞–≤–ª—è–µ–º –±–∏–ª–µ—Ç–∏–∫!`);
				acc = await acc + 1;
			} else {
				console.log(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å id: ${cur} –Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω –Ω–∞ –∫–∞–Ω–∞–ª`);
			}
		} catch (error) {
			console.log(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å id: ${cur} –Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω –Ω–∞ –∫–∞–Ω–∞–ª`);
		}
		return acc;
	}, 0)
	await ctx.reply(`–ò–∑ ${invitedUsers.length} –ø—Ä–∏–≥–ª–∞—à–µ–Ω–Ω—ã—Ö –í–∞–º–∏ –¥—Ä—É–∑–µ–π –ø–æ–¥–ø–∏—Å–∞–ª–∏—Å—å ${tickets} ! –ò—Ç–æ–≥–æ —É –≤–∞—Å:  ${tickets} –±–∏–ª–µ—Ç(–∞/–æ–≤)`, {
		reply_markup: menuKeyboard
	})
})

bot.command('getContestList', async (ctx) => {
	if (ctx.message.from.id == 951161100) {
		db.read()
		const usersList = Object.keys(db.data.users)
		let contestList = {}
		for (let i = 0; i < usersList.length; i++) {
			const invitedUsers = db.data.users[usersList[i]]
			const invitedUsersCount = invitedUsers.length
			contestList = {
				...contestList,
				[usersList[i]]: invitedUsersCount
			}
		}
		await cl.read()
		await cl.update(({}) => {
			console.log('–ó–∞–ø–∏—Å—å...');
			cl.data = {...contestList}
		})
		return cl;
	}
})

bot.hears('–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∏–ª–µ—Ç—ã', async (ctx) => {
	const userId = ctx.message.from.id;
	db.read()
	const invitedUsers = db.data.users[userId];
	let tickets = 0;
	tickets = await invitedUsers.reduce( async  (acc, cur) => {
		try {
			let pass = await bot.api.getChatMember('@shuratest', cur);
			if (pass.status == 'member') {
				console.log(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å id: ${cur} –ø–æ–¥–ø–∏—Å–∞–ª—Å—è –Ω–∞ –∫–∞–Ω–∞–ª, –¥–æ–±–∞–≤–ª—è–µ–º –±–∏–ª–µ—Ç–∏–∫!`);
				acc = await acc + 1;
			} else {
				console.log(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å id: ${cur} –Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω –Ω–∞ –∫–∞–Ω–∞–ª`);
			}
		} catch (error) {
			console.log(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å id: ${cur} –Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω –Ω–∞ –∫–∞–Ω–∞–ª`);
		}
		return acc;
	}, 0)
	await ctx.reply(`–ò–∑ ${invitedUsers.length} –ø—Ä–∏–≥–ª–∞—à–µ–Ω–Ω—ã—Ö –í–∞–º–∏ –¥—Ä—É–∑–µ–π –ø–æ–¥–ø–∏—Å–∞–ª–∏—Å—å ${tickets} ! –ò—Ç–æ–≥–æ —É –≤–∞—Å:  ${tickets} –±–∏–ª–µ—Ç(–∞/–æ–≤)`, {
		reply_markup: menuKeyboard
	})
})

bot.hears('–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ –∫–∞–Ω–∞–ª', async (ctx) => {
	let id = ctx.msg.from.id;
	let username = ctx.msg.from.username;
	let pass = await bot.api.getChatMember('@shuratest', id);

	if (pass.status == 'left') {
		await ctx.reply('–í—ã –Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω—ã –Ω–∞ –∫–∞–Ω–∞–ª',
			{
				reply_parameters: { message_id: ctx.msg.message_id },
				reply_markup: onFailSubKeyboard
			}
		)
	} else {
		await ctx.reply('–í—ã –ø–æ–¥–ø–∏—Å–∞–Ω—ã –Ω–∞ –∫–∞–Ω–∞–ª, –ø—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –¥—Ä—É–∑–µ–π –¥–ª—è —É—á–∞—Å—Ç–∏—è –≤ —Ä–æ–∑—ã–≥—Ä—ã—à–µ',
			{
				reply_parameters: { message_id: ctx.msg.message_id },
				reply_markup: shareUserKeyboard
			}
		)
	}
})

bot.hears('–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞', async (ctx) => {
	await ctx.reply('–í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤', {
		reply_markup: {
			keyboard: createChooseUserBtn(ctx),
			resize_keyboard: true,
			one_time_keyboard: true
		}
	})
})

bot.on(':users_shared', async (ctx) => {
	let sub = ctx.message.from.id
	let newUser = ctx.message.users_shared.users[0];
	let id = newUser.user_id;
	console.log('sub: ', sub, 'newUser: ', id );

	try {
		const pass = await bot.api.getChatMember('@shuratest', id);
		newUser.status = pass.status

		if (newUser.status == 'left') {
			console.log('–°—Ä–∞–±–æ—Ç–∞–ª 1');
			await ctx.reply('–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ–ª—É—á–µ–Ω—ã üëç')
			await ctx.reply('–î–ª—è —É—á–∞—Å—Ç–∏—è –≤ —Ä–æ–∑—ã–≥—Ä—ã—à–µ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –¥—Ä—É–≥—É: https://t.me/+hA7XB2pUFmJlZDgy')
			await ctx.reply(`–ö–∞–∫ —Ç–æ–ª—å–∫–æ –æ–Ω –ø–æ–¥–ø–∏—à–µ—Ç—Å—è –Ω–∞ –∫–∞–Ω–∞–ª, –≤–∞–º –¥–æ–±–∞–≤–∏—Ç—Å—è –±–∏–ª–µ—Ç —Ä–æ–∑—ã–≥—Ä—ã—à–∞. –ü–æ–º–Ω–∏—Ç–µ, —á–µ–º –±–æ–ª—å—à–µ –¥—Ä—É–∑–µ–π –ø–æ–¥–ø–∏—à–µ—Ç—Å—è –Ω–∞ –∫–∞–Ω–∞–ª, —Ç–µ–º –≤—ã—à–µ —à–∞–Ω—Å –Ω–∞ –ø–æ–±–µ–¥—É`, {
				reply_markup: {
					keyboard: createChooseUserBtn(ctx),
					resize_keyboard: true,
					one_time_keyboard: true
				}
			})
			db.read()
			db.update(({ users }) => {
				if (!Object.hasOwn(users, sub)) {
					console.log('–°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –¥–ª—è –ø–æ–¥–ø–∏—Å—á–∏–∫–∞ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞–∞—Ç–µ–ª—è –≤ –º–∞—Å—Å–∏–≤');
					users[sub] = [];
					users[sub].push(id)
				} else if (users[sub].includes(id)) {
					console.log('–≠—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –º–∞—Å—Å–∏–≤');
				} else {
					console.log('–î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –º–∞—Å—Å–∏–≤')
					users[sub].push(id)
				}
			})
			return db;
		} else if (newUser.status == 'kicked') {
			await ctx.reply(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${newUser.username} –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∑–∞ –Ω–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª –∫–∞–Ω–∞–ª–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–≥–æ —á–µ–ª–æ–≤–∫–∞`, {
				reply_markup: {
					keyboard: createChooseUserBtn(ctx),
					resize_keyboard: true,
					one_time_keyboard: true
				}
			})
		} else await ctx.reply(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${newUser.username} —É–∂–µ –ø–æ–¥–ø–∏—Å–∞–Ω –Ω–∞ –∫–∞–Ω–∞–ª, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–≥–æ —á–µ–ª–æ–≤–∫–∞`, {
				reply_markup: {
					keyboard: createChooseUserBtn(ctx),
					resize_keyboard: true,
					one_time_keyboard: true
				}
			})
	} catch (error) {
		console.log('–°—Ä–∞–±–æ—Ç–∞–ª Catch');
		await ctx.reply('–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ–ª—É—á–µ–Ω—ã üëç')
		await ctx.reply('–î–ª—è —É—á–∞—Å—Ç–∏—è –≤ —Ä–æ–∑—ã–≥—Ä—ã—à–µ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –¥—Ä—É–≥—É: https://t.me/+hA7XB2pUFmJlZDgy')
		await ctx.reply(`–ö–∞–∫ —Ç–æ–ª—å–∫–æ –æ–Ω –ø–æ–¥–ø–∏—à–µ—Ç—Å—è –Ω–∞ –∫–∞–Ω–∞–ª, –≤–∞–º –¥–æ–±–∞–≤–∏—Ç—Å—è –±–∏–ª–µ—Ç —Ä–æ–∑—ã–≥—Ä—ã—à–∞. –ü–æ–º–Ω–∏—Ç–µ, —á–µ–º –±–æ–ª—å—à–µ –¥—Ä—É–∑–µ–π –ø–æ–¥–ø–∏—à–µ—Ç—Å—è –Ω–∞ –∫–∞–Ω–∞–ª, —Ç–µ–º –≤—ã—à–µ —à–∞–Ω—Å –Ω–∞ –ø–æ–±–µ–¥—É`, {
			reply_markup: {
				keyboard: createChooseUserBtn(ctx),
				resize_keyboard: true,
				one_time_keyboard: true
			}
		})
		db.read()
		db.update(({ users }) => {
			if (!Object.hasOwn(users, sub)) {
				console.log('–°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –¥–ª—è –ø–æ–¥–ø–∏—Å—á–∏–∫–∞ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞–∞—Ç–µ–ª—è –≤ –º–∞—Å—Å–∏–≤');
				users[sub] = [];
				users[sub].push(id)
			} else if (users[sub].includes(id)) {
				console.log('–≠—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –º–∞—Å—Å–∏–≤');
			} else {
				console.log('–î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –º–∞—Å—Å–∏–≤')
				users[sub].push(id)
			}
		})
		return db;
	}
	})
	
bot.hears('<- –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é', async (ctx) => {
	await ctx.reply('–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ',
		{
			reply_markup: menuKeyboard
		}
	)
})

bot.hears('–ü–µ—Ä–µ–π—Ç–∏ –≤ —Ç–≥-–∫–∞–Ω–∞–ª', async (ctx) => {
	await ctx.reply(`[Shura Test Channel](https://t.me/shuratest)`,
		{
			parse_mode: 'MarkdownV2',
			disable_web_page_preview: true
		})
})

bot.hears('–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª', (ctx) => {
	ctx.reply('–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ç–≥ –∫–∞–Ω–∞–ª, –ø–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –∏ –≤–æ–∑–≤—Ä–∞—â–∞–π—Ç–µ—Å—å –∫–æ –º–Ω–µ: <a href="https://t.me/shuratest">Shura Test</a>', {
		parse_mode: 'HTML',
	})
})

bot.catch((err) => {
	const ctx = err.ctx;
	console.error(`Error while handling update ${ctx.update.update_id}:`);
	const e = err.error;

	if (e instanceof GrammyError) {
		console.error("Error in request:", e);
	} else if (e instanceof HttpError) {
		console.error("Could not connect to Telegram", e);
	} else {
		console.error('Unknown error:', e);
	}
})
bot.start();
